/**
 * Quran API Service
 *
 * Fetches Elmalılı Hamdi Yazır translation from alquran.cloud API.
 * Groups ayahs by Surah for clean rendering.
 */

// Surah name mapping (Arabic → Turkish)
const SURAH_NAMES_TR: Record<number, string> = {
  1: "Fatiha",
  2: "Bakara",
  3: "Âl-i İmrân",
  4: "Nisâ",
  5: "Mâide",
  6: "En'âm",
  7: "A'râf",
  8: "Enfâl",
  9: "Tevbe",
  10: "Yûnus",
  11: "Hûd",
  12: "Yûsuf",
  13: "Ra'd",
  14: "İbrâhîm",
  15: "Hicr",
  16: "Nahl",
  17: "İsrâ",
  18: "Kehf",
  19: "Meryem",
  20: "Tâ-Hâ",
  21: "Enbiyâ",
  22: "Hac",
  23: "Mü'minûn",
  24: "Nûr",
  25: "Furkân",
  26: "Şuarâ",
  27: "Neml",
  28: "Kasas",
  29: "Ankebût",
  30: "Rûm",
  31: "Lokmân",
  32: "Secde",
  33: "Ahzâb",
  34: "Sebe'",
  35: "Fâtır",
  36: "Yâsîn",
  37: "Sâffât",
  38: "Sâd",
  39: "Zümer",
  40: "Mü'min",
  41: "Fussilet",
  42: "Şûrâ",
  43: "Zuhruf",
  44: "Duhân",
  45: "Câsiye",
  46: "Ahkâf",
  47: "Muhammed",
  48: "Fetih",
  49: "Hucurât",
  50: "Kâf",
  51: "Zâriyât",
  52: "Tûr",
  53: "Necm",
  54: "Kamer",
  55: "Rahmân",
  56: "Vâkıa",
  57: "Hadîd",
  58: "Mücâdele",
  59: "Haşr",
  60: "Mümtehine",
  61: "Saff",
  62: "Cuma",
  63: "Münâfikûn",
  64: "Tegâbün",
  65: "Talâk",
  66: "Tahrîm",
  67: "Mülk",
  68: "Kalem",
  69: "Hâkka",
  70: "Meâric",
  71: "Nûh",
  72: "Cin",
  73: "Müzzemmil",
  74: "Müddessir",
  75: "Kıyâme",
  76: "İnsan",
  77: "Mürselât",
  78: "Nebe'",
  79: "Nâziât",
  80: "Abese",
  81: "Tekvîr",
  82: "İnfitâr",
  83: "Mutaffifîn",
  84: "İnşikâk",
  85: "Bürûc",
  86: "Târık",
  87: "A'lâ",
  88: "Gâşiye",
  89: "Fecr",
  90: "Beled",
  91: "Şems",
  92: "Leyl",
  93: "Duhâ",
  94: "İnşirâh",
  95: "Tîn",
  96: "Alak",
  97: "Kadir",
  98: "Beyyine",
  99: "Zilzâl",
  100: "Âdiyât",
  101: "Kâria",
  102: "Tekâsür",
  103: "Asr",
  104: "Hümeze",
  105: "Fîl",
  106: "Kureyş",
  107: "Mâûn",
  108: "Kevser",
  109: "Kâfirûn",
  110: "Nasr",
  111: "Tebbet",
  112: "İhlâs",
  113: "Felak",
  114: "Nâs",
};

export interface Verse {
  number: number; // Surah-internal ayah number
  text: string;
}

export interface SurahSection {
  surahNumber: number;
  surahName: string;
  verses: Verse[];
}

export interface JuzData {
  juzNumber: number;
  sections: SurahSection[];
  totalVerses: number;
}

// In-memory cache
const cache: Record<number, JuzData> = {};

export async function fetchJuz(juzNumber: number): Promise<JuzData> {
  // Check cache first
  if (cache[juzNumber]) {
    return cache[juzNumber];
  }

  const res = await fetch(
    `https://api.alquran.cloud/v1/juz/${juzNumber}/tr.yazir`,
  );

  if (!res.ok) {
    throw new Error(`API hatası: ${res.status}`);
  }

  const json = await res.json();
  const ayahs = json.data.ayahs;

  // Group by Surah
  const surahMap = new Map<number, SurahSection>();

  for (const ayah of ayahs) {
    const surahNum = ayah.surah.number;

    if (!surahMap.has(surahNum)) {
      surahMap.set(surahNum, {
        surahNumber: surahNum,
        surahName: SURAH_NAMES_TR[surahNum] || ayah.surah.englishName,
        verses: [],
      });
    }

    surahMap.get(surahNum)!.verses.push({
      number: ayah.numberInSurah,
      text: ayah.text,
    });
  }

  const result: JuzData = {
    juzNumber,
    sections: Array.from(surahMap.values()),
    totalVerses: ayahs.length,
  };

  // Cache it
  cache[juzNumber] = result;

  return result;
}
